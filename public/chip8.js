"use strict";var _createClass=function(){function a(a,b){for(var c in b){var d=b[c];d.configurable=!0,d.value&&(d.writable=!0)}Object.defineProperties(a,b)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},Chip8=function(){function a(){_classCallCheck(this,a),this.debug=!0}return _createClass(a,{loadGame:{value:function(a){for(var b=0;b<a.byteLength;b++)this.memory[b+512]=a[b]}},clearDisplay:{value:function(){for(var a=0;a<this.screen.length;a++)this.screen[a]=0}},reset:{value:function(){var a,b=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];this.opcode=0;var c=new ArrayBuffer(4096);for(this.memory=new Uint8Array(c),a=0;a<this.memory.length;a++)this.memory[a]=0;for(a=0;a<b.length;a++)this.memory[a]=b[a];for(this.V=new Array(16),a=0;a<this.V.length;a++)this.V[a]=0;for(this.I=0,this.PC=512,this.screen=new Array(2048),this.clearDisplay(),this.delayTimer=0,this.soundTimer=0,this.stack=new Array(16),a=0;a<this.stack.length;a++)this.stack[a]=0;for(this.SP=0,this.key=new Array(16),a=0;a<this.key.length;a++)this.key[0]=0;this.state=2,this.draw=!1}},emulateCycle:{value:function(){this.opcode=this.memory[this.PC]<<8|this.memory[this.PC+1];var a=(3840&this.opcode)>>8,b=(240&this.opcode)>>4;switch(this.delayTimer>0&&this.delayTimer--,this.soundTimer>0&&(1==this.soundTimer&&console.log("BEEP"),this.soundTimer--),61440&this.opcode){case 0:switch(255&this.opcode){case 224:this.clearDisplay(),console.log("CLS"),this.draw=!0,this.debug&&console.log(Utils.toHex(this.opcode)+" CLS");break;case 238:this.PC=this.stack[this.SP--],this.state=0,this.debug&&console.log(Utils.toHex(this.opcode)+" RET");break;default:console.log("Unknown opcode: "+Utils.toHex(this.opcode))}break;case 4096:this.PC=4095&this.opcode,this.state=0,this.debug&&console.log(Utils.toHex(this.opcode)+" JP addr");break;case 8192:this.stack[this.SP]=this.PC,this.SP++,this.PC=4095&this.opcode,this.state=0,this.debug&&console.log(Utils.toHex(this.opcode)+" CALL addr");break;case 12288:this.V[a]==(255&this.opcode)&&(this.state=4),this.debug&&console.log(Utils.toHex(this.opcode)+" SE Vx, byte");break;case 16384:this.V[a]!=(255&this.opcode)&&(this.state=4),this.debug&&console.log(Utils.toHex(this.opcode)+" SNE Vx, byte");break;case 20480:this.V[a]==this.V[b]&&(this.state=4),this.debug&&console.log(Utils.toHex(this.opcode)+" SE Vx, Vy");break;case 24576:this.V[a]=255&this.opcode,this.debug&&console.log(Utils.toHex(this.opcode)+" LD Vx, byte");break;case 28672:var c=(255&this.opcode)+this.V[a];c>255&&(c-=256),this.V[a]=c,this.debug&&console.log(Utils.toHex(this.opcode)+" ADD Vx, byte");break;case 32768:switch(15&this.opcode){case 0:this.V[a]=this.V[b],this.debug&&console.log(Utils.toHex(this.opcode)+" LD Vx, Vy");break;case 1:this.V[a]|=this.V[b],this.debug&&console.log(Utils.toHex(this.opcode)+" OR Vx, Vy");break;case 2:this.V[a]&=this.V[b],this.debug&&console.log(Utils.toHex(this.opcode)+" AND Vx, Vy");break;case 3:this.V[a]^=this.V[b],this.debug&&console.log(Utils.toHex(this.opcode)+" XOR Vx, Vy");break;case 4:this.V[a]+=this.V[b],this.V[15]=+(this.v[a]>255),this.V[a]>255&&(this.V[a]-=256),this.debug&&console.log(Utils.toHex(this.opcode)+" ADD Vx, Vy");break;case 5:this.V[15]=+(this.V[a]>this.V[b]),this.V[a]-=this.V[b],this.V[a]<0&&(this.V[a]+=256),this.debug&&console.log(Utils.toHex(this.opcode)+" SUB Vx, Vy");break;case 6:this.V[15]=1&this.V[a],this.V[a]>>=1,this.debug&&console.log(Utils.toHex(this.opcode)+" SHR Vx {, Vy}");break;case 7:this.V[15]=+(this.V[b]>this.V[a]),this.V[a]=this.V[b]-this.V[a],this.V[a]<0&&(this.V[a]+=256),this.debug&&console.log(Utils.toHex(this.opcode)+" SUBN Vx, Vy");break;case 14:this.V[15]=+(128&this.V[a]),this.V[a]<<=1,this.V[a]>255&&(this.V[a]-=256),this.debug&&console.log(Utils.toHex(this.opcode)+" SHL Vx {, Vy}");break;default:console.log("Unknown opcode: "+Utils.toHex(this.opcode))}break;case 36864:this.V[a]!=this.V[b]&&(this.state=4),this.debug&&console.log(Utils.toHex(this.opcode)+" SNE Vx, Vy");break;case 40960:this.I=4095&this.opcode,this.state=4,this.debug&&console.log(Utils.toHex(this.opcode)+" LD I, addr");break;case 45056:this.PC=(4095&this.opcode)+this.V[0],this.state=0,this.debug&&console.log(Utils.toHex(this.opcode)+" JP V0, addr");break;case 49152:this.V[a]=Math.floor(255*Math.random())&(255&this.opcode),this.debug&&console.log(Utils.toHex(this.opcode)+" RND Vx, byte");break;case 53248:this.V[15]=0;for(var d=15&this.opcode,e=this.V[a],f=this.V[b],b=0;d>b;b++)for(var g=this.memory[this.I+b],a=0;8>a;a++)if(g&128>>a){var h=e+a,i=f+b;h>64&&(h-=64),0>h&&(h+=64),i>32&&(i-=32),0>i&&(i+=32),0!=this.screen[h+64*i]&&(this.V[15]=1),this.screen[h+64*i]^=1}this.draw=!0,this.debug&&console.log(Utils.toHex(this.opcode)+" DRW Vx, Vy, nibble");break;case 57344:switch(255&this.opcode){case 158:this.key[this.V[a]]&&(this.state=4),this.debug&&console.log(Utils.toHex(this.opcode)+" SKP Vx");break;case 161:this.key[this.V[a]]||(this.state=4),this.debug&&console.log(Utils.toHex(this.opcode)+" SKNP Vx");break;default:console.log("Unknown opcode: "+Utils.toHex(this.opcode))}break;case 61440:switch(255&this.opcode){case 7:this.V[a]=this.delayTimer,this.debug&&console.log(Utils.toHex(this.opcode)+" LD Vx, DT");break;case 10:this.currentKey&&(this.key[this.V[a]]=this.currentKey),this.V[a]=this.delayTimer,this.debug&&console.log(Utils.toHex(this.opcode)+" LD Vx, K");break;case 21:this.delayTimer=this.V[a],this.debug&&console.log(Utils.toHex(this.opcode)+" LD DT, Vx");break;case 24:this.soundTimer=this.V[a],this.debug&&console.log(Utils.toHex(this.opcode)+" LD ST, Vx");break;case 30:this.I+=this.V[a],this.debug&&console.log(Utils.toHex(this.opcode)+" ADD I, Vx");break;case 41:this.I=5*this.V[a],this.debug&&console.log(Utils.toHex(this.opcode)+" LD F, Vx");break;case 51:this.memory[this.I]=parseInt(this.V[a]/100),this.memory[this.I+1]=parseInt(this.V[a]%100/10),this.memory[this.I+2]=parseInt(this.V[a]%10),this.debug&&console.log(Utils.toHex(this.opcode)+" LD B, Vx");break;case 85:for(var j=0;a>=j;j++)this.memory[this.I+j]=this.V[j];this.debug&&console.log(Utils.toHex(this.opcode)+" LD [I], Vx");break;case 101:for(var j=0;a>=j;j++)this.V[j]=this.memory[this.I+j];this.debug&&console.log(Utils.toHex(this.opcode)+" LD Vx, [I]");break;default:console.log("Unknown opcode: "+Utils.toHex(this.opcode))}break;default:console.log("Unknown opcode: "+Utils.toHex(this.opcode))}this.PC+=this.state,this.state=2}}}),a}(),Utils=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,{toHex:{value:function(a){var b=a.toString(16).toUpperCase();return"0x"+b}}}),a}(),_createClass=function(){function a(a,b){for(var c in b){var d=b[c];d.configurable=!0,d.value&&(d.writable=!0)}Object.defineProperties(a,b)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},Emulator=function(){function a(){_classCallCheck(this,a),this.load(),this.chip8=new Chip8,this.cvs=document.getElementById("canvas"),this.ctx=this.cvs.getContext("2d"),this.cvs.width=640,this.cvs.height=320,this.paletteList=[["#000000","#FFFFFF"],["#665178","#A9CDC3"],["#4D5E5F","#F84934"],["#1493A5","#F1EADC"],["#003A54","#325D6F"]],this.n=0,this.palette=Math.round(Math.random()*(this.paletteList.length-1))}return _createClass(a,{load:{value:function(){var a=this,b=new XMLHttpRequest;b.open("GET","roms/invaders",!0),b.responseType="arraybuffer",b.onload=function(){var c=new Uint8Array(b.response);a.chip8.reset(),a.chip8.loadGame(c),a.loop()},b.send()}},loop:{value:function(){var a=this;setTimeout(function(){if(a.n>-1){for(var b=0;1>b;b++)a.chip8.emulateCycle();if(a.chip8.draw){a.ctx.fillStyle=a.paletteList[a.palette][0],a.ctx.fillRect(0,0,640,320),a.ctx.fillStyle=a.paletteList[a.palette][1];for(var c=0;64>c;c++)for(var d=0;32>d;d++)a.chip8.screen[c+64*d]&&a.ctx.fillRect(10*c,10*d,10,10);a.chip8.draw=!1}a.n++}window.requestAnimationFrame(function(){a.loop()})},100)}}}),a}(),_createClass=function(){function a(a,b){for(var c in b){var d=b[c];d.configurable=!0,d.value&&(d.writable=!0)}Object.defineProperties(a,b)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},Utils=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,{toHex:{value:function(a){return"0x"+a.toString(16)}}}),a}();